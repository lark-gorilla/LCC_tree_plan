---
title: "Leeds Tree-planting Prioritization"
author: "Mark Miller"
date: "9 October 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries and read in attributed planning units

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(sf)
library(prioritizr)
library(leaflet)
#library(ggplot2)

pu_all<-read_sf('C:/trees/modelling/demo/final_PU_attrib.shp')
names(pu_all)[names(pu_all)=='X2050__']<-'yield'
# read in data for connectivity matrix
pubuff_road<-st_read('C:/trees/modelling/demo/PU_10mbuff_roads_updated.shp')# read manually edited file
cm<-connected_matrix(as(pubuff_road, 'Spatial'))
# make cost * area layer
pu_all$cost2<-pu_all$car_pot*pu_all$cost
# same for deprivation indices
pu_all$mst30dp<-pu_all$car_pot*pu_all$mst30dp
pu_all$md30t60<-pu_all$car_pot*pu_all$md30t60
```

### Landcover -> Planning unit cost layer

Our planning units (PUs) cover Leeds City Council wards and have all non-green spaces areas (e.g. buildings, infrastructure etc) removed. The planning units represent plantable areas of land, each with associated costs for conversion from current land use to tree planting.  

Planning unit landcover is theoretically available for planting and binned into 4 cost classes: existing tree cover = 0 (free); all others are 1,2 or 3 representing increasing difficulty/cost to plant on. 
```{r, echo=FALSE}

tab1<-pu_all%>%st_set_geometry(NULL)%>%group_by(prmryFn)%>%summarise(cost=first(cost))
tab1%>%as.data.frame()
#stargazer(tab1, type='text')

#ggplot(pu_all)+geom_sf(aes(fill=prmryFn))+theme_bw()+ggtitle('Landcover')
```

# Plot landcover and cost layer using above table for conversion

```{r, echo=FALSE}
#ggplot(pu_all)+geom_sf(aes(fill=factor(cost)))+theme_bw()+ggtitle('Cost')
plot(pu_all['prmryFn'],border=NA, main='Landcover')
plot(pu_all['cost'],border=NA, main='Planning unit cost')
plot(pu_all['cost2'],border=NA, main='Planning unit cost * area')
```

#### Features to prioritize in the tree planting network

We want to create a tree planting network that minimses the cost of planting (above) while maximising the following features: 

1) Carbon sequestration; dependent on a planning unit's area and the expected yield class of planted woodland; larger areas with higher modelled yield are expected to sequester more carbon.

2) Planting in socially deprived areas; both intermediate and highly deprived areas will be prioritized.

3) Planting in areas to mitigate flooding.

```{r, echo=FALSE}
plot(pu_all['car_pot'],border=NA, main='Available tree planting area - carbon sequestration 1')
#ggplot(pu_all)+geom_sf(aes(fill=car_pot))+theme_bw()+ggtitle('Carbon potential')
plot(pu_all['yield'],border=NA, main='Potential planting yield - carbon sequestration 2')
#ggplot(pu_all)+geom_sf(aes(fill=mst30dp))+theme_bw()+ggtitle('Highest 30% Deprivation')
plot(pu_all['mst30dp'],border=NA, main='High deprivation')
#ggplot(pu_all)+geom_sf(aes(fill=md30t60))+theme_bw()+ggtitle('Intermediate Deprivation')
plot(pu_all['md30t60'],border=NA, main='Intermediate deprivation')
#ggplot(pu_all)+geom_sf(aes(fill=flood))+theme_bw()+ggtitle('Priority flood planting')
plot(pu_all['flood'],border=NA, main='Priority flood planting')
```

### Initiate prioritizr problem and set up target parameters. Using cost*area cost layer

```{r}
p1<-problem(as(pu_all, 'Spatial'), features=c('car_pot', 'yield','mst30dp', "md30t60", 'flood'),cost_column='cost2')
```
Our planning units cover 362609999 m2 (~362 km2)  

```{r}
sum(pu_all$car_pot)
```
But 68084591 (~68 km2) of these planning uits represent existing tree cover, so the maximum remaining area we could plant is 294525408 m2 (~294 km2). Any target area of planting needs to be above 68 km2, otherwise we're not planting new trees.
```{r}
sum(pu_all[pu_all$cost==0,]$car_pot, na.rm=T)
sum(pu_all$car_pot)-sum(pu_all[pu_all$cost==0,]$car_pot, na.rm=T)
```
The total yield covering all 88031 planning units is 758839.
```{r}
sum(pu_all$yield)
nrow(pu_all)
```
We can have a max target of 60417330 m2 (~60 km2) of areas with high deprivation.
```{r}
sum(pu_all$mst30dp, na.rm=T)
```
We can have a max target of 94400206 m2 (~94 km2) of areas with intermediate deprivation.
```{r}
sum(pu_all$md30t60, na.rm=T)
```
We can have a max target of 51218396 m2 (~51 km2) area of priority flood planting.
```{r}
sum(pu_all$flood, na.rm=T)
```


Design a tree planting network with targets that:

double current tree cover (~ 140 km2);
include 50% of the total available yield;
include 50% of highly deprived areas (~30 km2);
include 25% of intermediate deprived areas (~23 km2);
include 50% of priority flood mitigation areas (~25 km2).

```{r}
targets<-c(140000000, 379419, 30208665,23600052, 25609198)
```

### Run prioritizr

The optimal tree planting network will meet the above targets while minimising the cost of converting exisitng landcover into forest. To include biodiversity connectivity in the network we specify that each planning unit selected for tree planting must be connected (within 10m and not crossed by a major raod) to at least one other selected planning. Additionally, all planning units that represent existing tree cover are 'locked in' so that they will form the basis of the connected planting network.

```{r}
p2<-p1%>%add_min_set_objective() %>%   
  add_absolute_targets(targets)%>%
  add_neighbor_constraints(k=1, data=cm) %>%
  add_locked_in_constraints(locked_in=pu_all$cost==0)
presolve_check(p2)

s1<-solve(p2) # calls Gurobi
```

plot solution

```{r}
pu_all$initial.run<-s1$solution_1

#ggplot(pu_all)+geom_sf(aes(fill=factor(sol)))+theme_bw()+ggtitle('Planning solution 1')
plot(pu_all['initial.run'], border=NA, pal=c('lavender','black'),main='Initial planning solution (black in network)')
```

### adjust feature target parameters and observe solution change 

Tree planting area target remains constant (140km2)
Yield class either: 189709 (25%), 379419(50% initial) or 569129 (75%)
High deprivation either: 15104333 (25%), 30208665 (50% inital) or 45312998 (75%)
Intermediate deprivation either: 23600052 (25% Initial), 47200103 (50%) or 70800155 (75%)
Piority flood mitigation either: 12804599 (25%), 25609198 (50% inital) or 38413797 (75%)


## Note: solutions do differ in the total number of planning units used to meet their targets, but all targets are met in each solution

```{r, echo=F, message=FALSE, warning=FALSE, include=F}

targets2<-rbind(data.frame(car_pot=140000000, yield=c(189709, 379419 ,569129), mst30dp=30208665, md30t60=23600052, flood= 25609198, name='Yield', lev=c('low', 'med', 'high')),
        data.frame(car_pot=140000000, yield=379419, mst30dp=c(15104333, 30208665, 45312998), md30t60=23600052, flood= 25609198, name='High Depr', lev=c('low', 'med', 'high')),
        data.frame(car_pot=140000000, yield=379419, mst30dp=30208665, md30t60=c(23600052, 47200103, 70800155), flood= 25609198, name='Intermediate Depr', lev=c('low', 'med', 'high')),
        data.frame(car_pot=140000000, yield=379419, mst30dp=30208665, md30t60=23600052, flood= c(12804599, 25609198, 38413797), name='Flood mitigaton', lev=c('low', 'med', 'high')))
 
for (i in 1:nrow(targets2)){
  p3<-p1%>%add_min_set_objective() %>%   
  add_absolute_targets(as.integer(paste(targets2[i,1:5])))%>%
  add_neighbor_constraints(k=1, data=cm) %>%
  add_locked_in_constraints(locked_in=pu_all$cost==0)
  
  s2<-solve(p3) 
 pu_all$tempsol<-s2$solution_1
 names(pu_all)[names(pu_all)=='tempsol']<-paste0('run.with.',targets2[i,7],'.',targets2[i,6])
 print(i)}             
```
```{r, echo=F}

plot(pu_all[11], border=NA, pal=c('lavender','black'))
plot(pu_all[12], border=NA, pal=c('lavender','black'))
plot(pu_all[13], border=NA, pal=c('lavender','black'))
plot(pu_all[13], border=NA, pal=c('lavender','black'))
plot(pu_all[14], border=NA, pal=c('lavender','black'))
plot(pu_all[15], border=NA, pal=c('lavender','black'))
plot(pu_all[16], border=NA, pal=c('lavender','black'))
plot(pu_all[17], border=NA, pal=c('lavender','black'))
plot(pu_all[18], border=NA, pal=c('lavender','black'))
plot(pu_all[19], border=NA, pal=c('lavender','black'))
plot(pu_all[20], border=NA, pal=c('lavender','black'))
plot(pu_all[21], border=NA, pal=c('lavender','black'))
plot(pu_all[22], border=NA, pal=c('lavender','black'))
plot(pu_all[23], border=NA, pal=c('lavender','black'))
```
